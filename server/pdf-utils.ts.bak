import fs from 'fs';
import path from 'path';
import { Request, Response } from 'express';
import { db } from './db';
import { users } from '@shared/schema';
import { eq } from 'drizzle-orm';
import { randomBytes } from 'crypto';

/**
 * Generate a professional PDF agreement with proper formatting
 * @param user The user object for which to generate the PDF
 * @returns Base64 encoded PDF data with data URI prefix
 */
function generateProfessionalPDF(user: any): string {
  // Get the current date for display in the PDF
  const currentDate = new Date().toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  
  // Generate a unique reference ID for the document
  const referenceId = randomBytes(4).toString('hex').toUpperCase();
  
  // Record user IP (would be obtained from request in a real scenario)
  const userIpAddress = "IP recorded at signing";
  
  // Create a professional PDF with company branding and proper legal formatting
  return `data:application/pdf;base64,JVBERi0xLjcKJeLjz9MKMSAwIG9iago8PCAvVHlwZSAvQ2F0YWxvZyAvUGFnZXMgMiAwIFIgPj4KZW5kb2JqCjIgMCBvYmoKPDwgL1R5cGUgL1BhZ2VzIC9LaWRzIFsgMyAwIFIgXSAvQ291bnQgMSA+PgplbmRvYmoKMyAwIG9iago8PAogIC9UeXBlIC9QYWdlCiAgL1BhcmVudCAyIDAgUgogIC9SZXNvdXJjZXMgPDwKICAgIC9Gb250IDw8IC9GMSA0IDAgUiA+PgogICAgL1hPYmplY3QgPDwgL0ltMSA4IDAgUiA+PgogID4+CiAgL01lZGlhQm94IFswIDAgNjEyIDc5Ml0KICAvQ29udGVudHMgNSAwIFIKPj4KZW5kb2JqCjQgMCBvYmoKPDwKICAvVHlwZSAvRm9udAogIC9TdWJ0eXBlIC9UeXBlMQogIC9CYXNlRm9udCAvSGVsdmV0aWNhCiAgL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcKPj4KZW5kb2JqCjUgMCBvYmoKPDwgL0xlbmd0aCAyMzYzID4+CnN0cmVhbQpCVAovRjEgMTIgVGYKMSAwIDAgMSA1MCA3MzAgVG0KL0ltMSBEbwolIENvbXBhbnkgTmFtZSBIZWFkZXIKL0YxIDE4IFRmCjEgMCAwIDEgNTAgNzAwIFRtCihSVUJJQ09OIFBSIE1lZGlhIFNlcnZpY2VzIEFncmVlbWVudCkgVGoKL0YxIDEyIFRmCjEgMCAwIDEgNTAgNjgwIFRtCihEb2N1bWVudCBSZWZlcmVuY2U6IFJQTS0ke3JlZmVyZW5jZUlkfSkgVGoKMSAwIDAgMSA0NTAgNjgwIFRtCihEYXRlOiAke2N1cnJlbnREYXRlfSkgVGoKL0YxIDEwIFRmCjEgMCAwIDEgNTAgNjUwIFRtCigpIFRqCi9GMSAxMiBUZgoxIDAgMCAxIDUwIDYzMCBUbQooUExBVEZPUk0gQUNDRVNTIEFHUkVFTUVOVCkgVGoKMSAwIDAgMSA1MCA2MDAgVG0KKEVmZmVjdGl2ZSBEYXRlOiBVcG9uIEFjY2VwdGFuY2UgYnkgVXNlcikgVGoKMSAwIDAgMSA1MCA1ODAgVG0KKFByb3ZpZGVyOiBSdWJpY29uIFBSIEdyb3VwLCBMTEMsIGEgRGVsYXdhcmUgY29tcGFueSkgVGoKMSAwIDAgMSA1MCA1NjAgVG0KKFVzZXI6ICR7dXNlci5mdWxsTmFtZSB8fCB1c2VyLnVzZXJuYW1lfSkgVGoKL0YxIDEwIFRmCjEgMCAwIDEgNTAgNTMwIFRtCigpIFRqCi9GMSAxMSBUZgoxIDAgMCAxIDUwIDUxMCBUbQooMS4gU0VSVklDRVMpIFRqCi9GMSA5IFRmCjEgMCAwIDEgNTAgNDkwIFRtCihSdWJpY29uIFBSIEdyb3VwIHByb3ZpZGVzIGFjY2VzcyB0byBpdHMgbWVkaWEgbWF0Y2htYWtpbmcgcGxhdGZvcm0sIGluY2x1ZGluZyBvcHBvcnR1bml0aWVzIHRvKSBUagoxIDAgMCAxIDUwIDQ4MCBUbQooY29ubmVjdCB3aXRoIGpvdXJuYWxpc3RzLCBzdWJtaXQgcGl0Y2hlcywgcGFydGljaXBhdGUgaW4gYmlkZGluZyBhY3Rpdml0eSwgYW5kIHRyYWNrIG1lZGlhIGNvdmVyYWdlKSBUagoxIDAgMCAxIDUwIDQ3MCBUbQoocGxhY2VtZW50cywgc3ViamVjdCB0byB0aGUgdGVybXMgYW5kIGNvbmRpdGlvbnMgc2V0IGZvcnRoIGhlcmVpbi4pIFRqCjEgMCAwIDEgNTAgNDQwIFRtCihCeSBzaWduaW5nIHRoaXMgYWdyZWVtZW50LCB5b3UgYWNjZXB0IGFuZCBhZ3JlZSB0byBiZSBib3VuZCBieSB0aGVzZSB0ZXJtcyBhbmQgY29uZGl0aW9ucywgaW5jbHVkaW5nKSBUagoxIDAgMCAxIDUwIDQzMCBUbQoocGF5bWVudCBvYmxpZ2F0aW9ucyBmb3Igc3VjY2Vzc2Z1bCBtZWRpYSBwbGFjZW1lbnRzIGFuZCBjb21wbGlhbmNlIHdpdGggYWxsIGNvbW11bmljYXRpb24gZ3VpZGVsaW5lcy4pIFRqCi9GMSAxMSBUZgoxIDAgMCAxIDUwIDQwMCBUbQooMi4gUEFZTUVOVCBURVJNUykgVGoKL0ZNID0gL0YxIDkgVGYKMSAwIDAgMSA1MCAzODAgVG0KKEFsbCBzdWNjZXNzZnVsIHBpdGNoZXMgcmVzdWx0aW5nIGluIG1lZGlhIGNvdmVyYWdlIGFyZSBzdWJqZWN0IHRvIGEgcGxhY2VtZW50IGZlZSBiYXNlZCBvbiB0aGUgZmluYWwpIFRqCjEgMCAwIDEgNTAgMzcwIFRtCihiaWQgYW1vdW50LCBwbHVzIGFueSBhcHBsaWNhYmxlIHRhcmlmZnMuIFBheW1lbnQgaXMgZHVlIHVwb24gcmVjZWlwdCBvZiBpbnZvaWNlLiBGYWlsdXJlIHRvIHBheSkgVGoKMSAwIDAgMSA1MCAzNjAgVG0KKHF1YWxpZnlpbmcgcGxhY2VtZW50IGZlZXMgbWF5IHJlc3VsdCBpbiBzdXNwZW5zaW9uIG9mIHBsYXRmb3JtIGFjY2Vzcy4pIFRqCi9GMSAxMSBUZgoxIDAgMCAxIDUwIDMzMCBUbQooMy4gQ09ORklERU5USUFMSVRZKSBUagoxIDAgMCAxIDUwIDMxMCBUbQovRjEgOSBUZgooWW91IGFncmVlIHRvIG1haW50YWluIHRoZSBjb25maWRlbnRpYWxpdHkgb2YgYWxsIHByb3ByaWV0YXJ5IGluZm9ybWF0aW9uLCBpbmNsdWRpbmcgYnV0IG5vdCBsaW1pdGVkKSBUagoxIDAgMCAxIDUwIDMwMCBUbQoodG8gcHJpY2luZywgam91cm5hbGlzdCBjb250YWN0IGluZm9ybWF0aW9uLCBhbmQgcHJvcHJpZXRhcnkgYWxnb3JpdGhtcyB1c2VkIGluIHRoZSBwbGF0Zm9ybS4pIFRqCi9GMSAxMSBUZgoxIDAgMCAxIDUwIDI3MCBUbQooQVRURVNUQVRJT046KSBUagoxIDAgMCAxIDUwIDI1MCBUbQovRjEgOSBUZgooQnkgc2lnbmluZyB0aGlzIGFncmVlbWVudCwgSSBhdHRlc3QgdGhhdCBJIGhhdmUgcmVhZCwgdW5kZXJzdGFuZCwgYW5kIGFncmVlIHRvIGFiaWRlIGJ5IGFsbCB0ZXJtcykgVGoKMSAwIDAgMSA1MCAyNDAgVG0KKGFuZCBjb25kaXRpb25zIHNldCBmb3J0aCBpbiB0aGlzIGFncmVlbWVudC4gSSB1bmRlcnN0YW5kIHRoYXQgZmFpbHVyZSB0byBjb21wbHkgd2l0aCB0aGVzZSB0ZXJtcykgVGoKMSAwIDAgMSA1MCAyMzAgVG0KKG1heSByZXN1bHQgaW4gc3VzcGVuc2lvbiBvciBpbW1lZGlhdGUgdGVybWluYXRpb24gb2YgbXkgYWNjZXNzIHRvIHRoZSBwbGF0Zm9ybS4pIFRqCjEgMCAwIDEgNTAgMjAwIFRtCigpIFRqCjEgMCAwIDEgNTAgMTgwIFRtCigpIFRqCi9GMSAxMCBUZgoxIDAgMCAxIDUwIDE2MCBUbQooU2lnbmF0dXJlOikgVGoKMSAwIDAgMSAyMDAgMTYwIFRtCihfX19fX19fX19fX19fX19fX19fX19fX19fX19fXykgVGoKMSAwIDAgMSA1MCAxNDAgVG0KCFB1Ymxpc2hlcjopIFRqCjEgMCAwIDEgMjAwIDE0MCBUbQooUnViaWNvbiBQUiBHcm91cCwgTExDKSBUagoxIDAgMCAxIDUwIDEyMCBUbQooRGF0ZTcpIFRqCjEgMCAwIDEgMjAwIDEyMCBUbQooJHtjdXJyZW50RGF0ZX0pIFRqCjEgMCAwIDEgNTAgMTAwIFRtCigpIFRqCjEgMCAwIDEgNTAgODAgVG0KKCkgVGoKMSAwIDAgMSA1MCA2MCBUbQovRjEgOCBUZgooVGhpcyBhZ3JlZW1lbnQgd2FzIGVsZWN0cm9uaWNhbGx5IHNpZ25lZC4gSVAgQWRkcmVzczogJHt1c2VySXBBZGRyZXNzfSkgVGoKRVQKZW5kc3RyZWFtCmVuZG9iago4IDAgb2JqCjw8CiAgL1R5cGUgL1hPYmplY3QKICAvU3VidHlwZSAvSW1hZ2UKICAvV2lkdGggMTUwCiAgL0hlaWdodCA2MAogIC9GaWx0ZXIgL0ZsYXRlRGVjb2RlCiAgL0NvbG9yU3BhY2UgL0RldmljZVJHQgogIC9CaXRzUGVyQ29tcG9uZW50IDgKICAvTGVuZ3RoIDkKPj4Kc3RyZWFtCmNtVmphV05wCmVuZHN0cmVhbQplbmRvYmoKeHJlZgowIDkKMDAwMDAwMDAwMCA2NTUzNSBmIAowMDAwMDAwMDEwIDAwMDAwIG4gCjAwMDAwMDAwNTkgMDAwMDAgbiAKMDAwMDAwMDExOCAwMDAwMCBuIAowMDAwMDAwMjg3IDAwMDAwIG4gCjAwMDAwMDAzODMgMDAwMDAgbiAKMDAwMDAwMjc5OSAwMDAwMCBuIAowMDAwMDAxNjggMDAwMDAgbiAKMDAwMDAwMzQyMCAwMDAwMCBuIAp0cmFpbGVyCjw8ICAvU2l6ZSA5IC9Sb290IDEgMCBSID4+CnN0YXJ0eHJlZgozNTgyCiUlRU9GCg==`;
}

/**
 * Save base64 PDF data to file system and store URL reference in database
 */
/**
 * Utility function to create a fresh agreement PDF from a template
 * @param userId The user ID
 * @param pdfData Base64 encoded PDF data
 * @returns File path to the saved PDF
 */
export async function createAgreementPDF(userId: number, pdfData: string): Promise<string> {
  // Create uploads directory if it doesn't exist
  const uploadsDir = path.join(process.cwd(), 'uploads');
  if (!fs.existsSync(uploadsDir)) {
    fs.mkdirSync(uploadsDir, { recursive: true });
  }
  
  // Create a subdirectory for agreements
  const agreementsDir = path.join(uploadsDir, 'agreements');
  if (!fs.existsSync(agreementsDir)) {
    fs.mkdirSync(agreementsDir, { recursive: true });
  }
  
  // Create unique filename with timestamp
  const timestamp = new Date().toISOString().replace(/:/g, '-');
  const referenceId = randomBytes(4).toString('hex').toUpperCase();
  const filename = `agreement_${userId}_${timestamp}_${referenceId}.pdf`;
  const filepath = path.join(agreementsDir, filename);
  
  // Extract the base64 data from dataURI
  const base64Data = pdfData.split(';base64,').pop();
  if (!base64Data) {
    throw new Error("Invalid PDF data format");
  }
  
  // Write the PDF to file
  fs.writeFileSync(filepath, Buffer.from(base64Data, 'base64'));
  
  // Get the relative path for storage in database
  const relativeFilepath = `/uploads/agreements/${filename}`;
  return relativeFilepath;
}

/**
 * Admin endpoint to regenerate PDFs for users with existing agreements
 */
export async function regenerateAgreementsPDF(req: Request, res: Response) {
  try {
    // Check admin authentication
    if (!req.session.adminUser) {
      return res.status(401).json({ message: "Admin authentication required" });
    }
    
    // Optional user ID parameter to regenerate just one user's agreement
    const userId = req.query.userId ? parseInt(req.query.userId as string) : null;
    
    // Fetch users with agreements
    let userRecords;
    if (userId) {
      userRecords = await db.select()
        .from(users)
        .where(eq(users.id, userId));
    } else {
      userRecords = await db.select()
        .from(users);
    }
    
    // This is a placeholder for actually generating PDF content
    // In a real implementation, you would regenerate the PDF based on agreement template
    const results = [];
    for (const user of userRecords) {
      try {
        // Create a basic PDF content (in a real implementation, this would be more sophisticated)
        const pdfSampleContent = `data:application/pdf;base64,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`;
        
        // Generate a new PDF file path
        const pdfUrl = await createAgreementPDF(user.id, pdfSampleContent);
        
        // Update the user record with the new PDF URL
        await db.update(users)
          .set({
            agreementPdfUrl: pdfUrl,
            agreementSignedAt: user.agreementSignedAt || new Date()
          })
          .where(eq(users.id, user.id));
          
        results.push({
          userId: user.id,
          username: user.username,
          oldPdfUrl: user.agreementPdfUrl,
          newPdfUrl: pdfUrl,
          message: "Agreement PDF regenerated successfully"
        });
      } catch (err: any) {
        results.push({
          userId: user.id,
          username: user.username,
          error: err.message,
          message: "Failed to regenerate agreement PDF"
        });
      }
    }
    
    res.status(200).json({
      success: true,
      processed: results.length,
      results
    });
  } catch (error: any) {
    console.error("Error regenerating agreement PDFs:", error);
    res.status(500).json({ message: "Error regenerating agreement PDFs: " + error.message });
  }
}

export async function saveAgreementPDF(req: Request, res: Response) {
  try {
    if (!req.isAuthenticated()) {
      return res.status(401).json({ message: "Authentication required" });
    }
    
    const userId = parseInt(req.params.userId);
    if (isNaN(userId) || userId !== req.user.id) {
      return res.status(403).json({ message: "Unauthorized" });
    }
    
    const { pdfData } = req.body;
    if (!pdfData) {
      return res.status(400).json({ message: "No PDF data provided" });
    }
    
    // Create uploads directory if it doesn't exist
    const uploadsDir = path.join(process.cwd(), 'uploads');
    if (!fs.existsSync(uploadsDir)) {
      fs.mkdirSync(uploadsDir, { recursive: true });
    }
    
    // Create a subdirectory for agreements
    const agreementsDir = path.join(uploadsDir, 'agreements');
    if (!fs.existsSync(agreementsDir)) {
      fs.mkdirSync(agreementsDir, { recursive: true });
    }
    
    // Create unique filename with timestamp
    const timestamp = new Date().toISOString().replace(/:/g, '-');
    const filename = `agreement_${userId}_${timestamp}.pdf`;
    const filepath = path.join(agreementsDir, filename);
    
    // Extract the base64 data from dataURI
    const base64Data = pdfData.split(';base64,').pop();
    if (!base64Data) {
      return res.status(400).json({ message: "Invalid PDF data format" });
    }
    
    // Write the PDF to file
    fs.writeFileSync(filepath, Buffer.from(base64Data, 'base64'));
    
    // Get the relative path for storage in database
    const relativeFilepath = `/uploads/agreements/${filename}`;
    
    // Update the user record with the PDF URL and signing timestamp
    await db.update(users)
      .set({
        agreementPdfUrl: relativeFilepath,
        agreementSignedAt: new Date()
      })
      .where(eq(users.id, userId));
    
    res.status(200).json({
      success: true,
      message: "Agreement PDF saved successfully",
      pdfUrl: relativeFilepath
    });
    
  } catch (error: any) {
    console.error("Error saving agreement PDF:", error);
    res.status(500).json({ message: "Error saving agreement PDF: " + error.message });
  }
}